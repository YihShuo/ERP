unit ShippingImport1;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, DB, StdCtrls, ExtCtrls, DBTables, Grids, DBGrids,dateutils,
  Buttons;

type
  TShippingImport = class(TForm)
    ScanData: TQuery;
    DS1: TDataSource;
    DBGrid1: TDBGrid;
    UpScan: TUpdateSQL;
    Panel3: TPanel;
    ScanDataDDBH: TStringField;
    ScanDataCTNO: TStringField;
    ScanDataUSERDate: TDateTimeField;
    ScanDataUSERID: TStringField;
    ScanDataYN: TStringField;
    DBGrid2: TDBGrid;
    SCSMCH: TQuery;
    DS2: TDataSource;
    SCSMCHDDBH: TStringField;
    SCSMCHCTNO: TStringField;
    SCSMCHArticle: TStringField;
    SCSMCHXieMing: TStringField;
    BB1: TBitBtn;
    BB2: TBitBtn;
    BB3: TBitBtn;
    BB4: TBitBtn;
    OpenDialog1: TOpenDialog;
    Query1: TQuery;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure BB3Click(Sender: TObject);
    procedure BB1Click(Sender: TObject);
    procedure BB4Click(Sender: TObject);
    procedure BB2Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  ShippingImport: TShippingImport;
  NDate:TDate;
  Filepath:string;
  Myfile:Textfile;

implementation

uses main1;

{$R *.dfm}

procedure TShippingImport.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
action:=cafree;
end;

procedure TShippingImport.BB3Click(Sender: TObject);
begin
ScanData.delete;
end;

procedure TShippingImport.BB1Click(Sender: TObject);
var
i:integer;
s:string;
begin
if opendialog1.Execute then
  begin
    filepath:=opendialog1.FileName;
  end;
if trim(filepath)='' then
  begin
    exit;
  end;
assignfile(Myfile,filepath);

try
  reset(myfile);
except
  showmessage('Have wrong.');
end;

try
ScanData.Active:=true;
i:=0;
while not seekeof(myfile) do
  begin
    readln(myfile,s);
    s:=trim(s);
    if trim(s)<>'' then
      begin
        with ScanData do
          begin
            insert;
            fieldbyname('DDBH').Value:=trim(copy(s,0,pos(' ',s)-1));
            fieldbyname('CTNO').Value:=trim(copy(s,pos(' ',s),pos(',',s)-pos(' ',s)));
            post;
          end;
      end;
    inc(i);
  end;
closefile(myfile);
BB2.Enabled:=true;
BB3.Enabled:=true;
SCSMCH.Active:=true;
except
  showmessage('Have wrong.');
end;

end;

procedure TShippingImport.BB4Click(Sender: TObject);
begin
close;
end;

procedure TShippingImport.BB2Click(Sender: TObject);
var i:integer;
DDBH,CTNO:string;
begin
if not Scandata.Active then
  begin
    abort;
  end;  
if Scandata.recordcount=0 then
  begin
    abort;
  end;
with Query1 do
  begin
    active:=false;
    sql.Clear;
    sql.add('select getdate() as NDate');
    active:=true;
    NDate:=fieldbyname('NDate').Value;
    active:=false;
  end;

try
    Scandata.first;
    while not Scandata.Eof do
      begin
        case Scandata.updatestatus of
          usinserted:
            begin
              DDBH:=Scandata.fieldbyname('DDBH').value;
              CTNO:=Scandata.fieldbyname('CTNO').value;
              Scandata.edit;
              Scandata.FieldByName('USERDATE').Value:=NDate;
              Scandata.FieldByName('USERID').Value:=main.edit1.text;
              Scandata.FieldByName('YN').Value:='1';
              Upscan.apply(ukinsert);
              with query1 do
                begin
                  active:=false;
                  sql.Clear;
                  sql.add('update SCSMRK ');
                  sql.add('set YN='+''''+'3'+'''');
                  sql.add('where DDBH='+''''+DDBH+'''');
                  sql.add('and CTNO='+''''+CTNO+'''');
                  execsql;
                end;
            end;
        end;
        Scandata.delete;  
        Scandata.first;
      end;
    Scandata.active:=false;
    SCSMCH.active:=false;
    BB2.Enabled:=false;
    BB3.Enabled:=false;
    if messagedlg('Keep to TXT files?',mtinformation,[mbYes,mbNo],0)=mrYes then
      begin
        if trim(filepath)<>'' then
          begin
            assignfile(Myfile,filepath);
            append(myfile);
            write(myfile,'Already write to database and keep.');
            closefile(myfile);
          end;
      end;
    showmessage('Succeed');
except
  Messagedlg('Have wrong, can not save!',mtwarning,[mbyes],0);
end;

end;

end.
