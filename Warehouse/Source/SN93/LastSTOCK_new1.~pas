unit LastSTOCK_new1;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, DBTables, DB, GridsEh, DBGridEh, ExtCtrls, StdCtrls, ComCtrls,comobj,
  Menus,ehlibBDE, ShellAPI ,DBGridEhImpExp , DateUtils, Buttons;

type
  TLastSizeR=record
   CLBH:string;
   IsSizR:array [0..39] of Boolean;
end;
//
type
  TLastSTOCK = class(TForm)
    panel2: TPanel;
    qry1: TQuery;
    ds1: TDataSource;
    EditMatNo: TEdit;
    lbl1: TLabel;
    btn1: TButton;
    pm1: TPopupMenu;
    S1: TMenuItem;
    dlgSave1: TSaveDialog;
    Qtemp1: TQuery;
    Label3: TLabel;
    EditMatNM: TEdit;
    DTP1: TDateTimePicker;
    Label4: TLabel;
    CBX1: TComboBox;
    Label2: TLabel;
    Panel1: TPanel;
    LastMonth: TLabel;
    BB1: TBitBtn;
    BB2: TBitBtn;
    bbt6: TBitBtn;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    dbgrdh1: TDBGridEh;
    qry2: TQuery;
    ds2: TDataSource;
    dbgrdh2: TDBGridEh;
    LastSizQ: TQuery;
    TabSheet3: TTabSheet;
    qry3: TQuery;
    ds3: TDataSource;
    dbgrdh3: TDBGridEh;
    procedure btn1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormDestroy(Sender: TObject);
    procedure S1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure bbt6Click(Sender: TObject);
    procedure BB1Click(Sender: TObject);
    procedure BB2Click(Sender: TObject);
    procedure DTP1Change(Sender: TObject);
    procedure dbgrdh1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
    procedure dbgrdh2DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
  private
    LastSizeR:array of TLastSizeR;
    LastMon:string; //上個月(Month)
    LastYear:string;//上個月(Year)
    STLastMonDate:string; //上個月初
    EDLastMonDate:string; //上個月底
    //
    LastMon2:string;//上上一個月(Month) 月結累積加總計算
    LastYear2:string;//上上一個月(Year)
    //
    STDate:string; //當月月初
    EDDate:string; //今天
    { Private declarations }
    procedure GetDateParam();
    function CheckLastMonthEnding():boolean;
    procedure OutputExcel(Query:TQuery);
    procedure Last_Size_Range_Init();
  public
    { Public declarations }
  end;

var
  LastSTOCK: TLastSTOCK;
  TCLBH:string;
  TLCRY:string;

implementation

uses  main1, Laststock_Det1, FunUnit;

{$R *.dfm}
//當月天數
function   DaysOfItsMonth(ADate:   TDateTime):   Word;
var
   Y,M,D:Word;
begin
    DecodeDate(ADate,Y,M,D);
    ADate:=EncodeDate(Y,M,1);
    Result:=Trunc(IncMonth(ADate,1)-ADate);
end;
//取得時間參數
procedure TLastSTOCK.GetDateParam();
var myYear, myMonth, myDay : Word;
    tmpDate:TDate;
begin
  //取得上個月起始和結束日期
  tmpDate:=incmonth(DTP1.Date,-1);
  DecodeDate(tmpDate, myYear, myMonth, myDay);
  LastMon:=Format('%.2d',[myMonth]);
  LastYear:=Format('%.4d',[myYear]);
  STLastMonDate:=FormatDateTime('YYYY/MM/DD', EncodeDate(myYear, myMonth, 1));  //月初日期
  EDLastMonDate:=FormatDateTime('YYYY/MM/DD', EncodeDate(myYear, myMonth, DaysOfItsMonth(tmpDate)));//月底
  if CheckLastMonthEnding()=false then
    LastMonth.Caption:=STLastMonDate+'-'+EDLastMonDate+' Khong co ket thuc hang thang!'
  else
    LastMonth.Caption:='';
  //取得上上個月用來月結資料累積加總
  tmpDate:=incmonth(DTP1.Date,-2);
  DecodeDate(tmpDate, myYear, myMonth, myDay);
  LastMon2:=Format('%.2d',[myMonth]);
  LastYear2:=Format('%.4d',[myYear]);
  //取得當月初和今天日期
  DecodeDate(DTP1.Date, myYear, myMonth, myDay);
  STDate:=FormatDateTime('YYYY/MM/DD', EncodeDate(myYear, myMonth, 1));  //月初日期
  EDDate:=FormatDateTime('YYYY/MM/DD', DTP1.Date);//基礎日
end;

procedure TLastSTOCK.btn1Click(Sender: TObject);
var year,month,day:word;
    i:integer;
    ayear,amonth:string;
begin
  if LastMonth.Caption<>'' then exit;
  
  decodedate(DTP1.Date,Year,Month,Day);   //找庫存相關的數據
  incAMonth(Year,Month,Day,-1);
  ayear:=floattostr(year);
  amonth:=floattostr(month);
  if length(amonth)=1 then
    amonth:='0'+amonth;

  with Qtemp1 do
  begin
    Active:=false;
    SQL.Clear;
    SQL.Add('select Siz as XXCC from ( ');
    SQL.Add('Select Siz from LastSizeR  Group by Siz ');
    SQL.Add('Union all ');
    SQL.Add('Select XXCC as Siz from Gender  Group by XXCC ) LastSizeR Group by Siz order by Siz ');
    Active:=true;
  end;
 //目前庫存
 if PageControl1.ActivePage=TabSheet1 then
 begin
   with Qry1 do
   begin
      Active:=false;
      SQL.Clear;
      sql.add('  if object_id('+''''+'tempdb..#CLZLKC_Last'+''''+') is not null  ');
      sql.add('begin   drop table #CLZLKC_Last end   ');
      SQL.Add('select NowKC.CKBH,NowKC.CLBH,NowKC.SIZ,IsNull(NowKC.NowRKQty,0)-IsNull(LL.LLQty,0) as Qty,LastKC.LastRem,RK.RKQty,LL.LLQty into #CLZLKC_Last from (');
      SQL.Add('  select CKBH,CLBH,SIZ,Sum(RKQty) as NowRKQty from (');
      SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
      SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+''' ');
      SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ ');
      SQL.Add('  Union All ');
      SQL.Add('  select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+''' and KCYEAR='''+ayear+''' and KCMonth='''+amonth+''' ) as tmpRKTLFL ');
      SQL.Add('  group by CKBH,CLBH,SIZ ) as NowKC');
      SQL.Add('left join ( ');
      SQL.Add('   select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+''' and KCYEAR='''+ayear+''' and KCMonth='''+amonth+''' ) as LastKC on NowKC.CKBH=LastKC.CKBH and NowKC.CLBH=LastKC.CLBH and NowKC.SIZ=LastKC.SIZ');
      SQL.Add('left join ( ');
      SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
      SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+''' ');
      SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ  ) RK on NowKC.CKBH=RK.CKBH and NowKC.CLBH=RK.CLBH and NowKC.SIZ=RK.SIZ');
      SQL.Add('left join ( ');
      SQL.Add('   select LTLL.CKBH,LTLLSS.CLBH,LTLLSS.SIZ,SUM(LTLLSS.Qty) as LLQty from LTLLSS,LTLL ');
      SQL.Add('   where LTLLSS.LLNO=LTLL.LLNO  and LTLL.CFMID<>''NO'' and LTLL.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTLL.CFMDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+''' ');
      SQL.Add('   Group by LTLL.CKBH,LTLLSS.CLBH,LTLLSS.SIZ ) LL on NowKC.CKBH=LL.CKBH and NowKC.CLBH=LL.CLBH and NowKC.SIZ=LL.SIZ');
      SQL.Add('select #CLZLKC_Last.CLBH,CLZL.YWPM, SUM(Qty) as Total,');
      for i:=0 to Qtemp1.RecordCount-1 do
      begin
        SQL.Add('   Max(case when SIZ='''+Qtemp1.FieldByName('XXCC').AsString+''' then Qty end) as ''['+Qtemp1.FieldByName('XXCC').AsString+']'', ');
        QTemp1.Next;
      end;
      SQL.Add('CLZL.CQDH ');
      SQL.Add('from #CLZLKC_Last  ');
      SQL.Add('left join CLZL on CLZL.cldh=#CLZLKC_Last.CLBH  where 1=1 ');
      if EditMatNo.Text<>'' then
        SQL.Add('and #CLZLKC_Last.CLBH like '''+EditMatNo.Text+'%'' ');
      if EditMatNM.Text<>'' then
        SQL.Add('and CLZL.YWPM like ''%'+EditMatNM.Text+'%'' ');
      SQL.Add('Group by #CLZLKC_Last.CLBH,CLZL.YWPM,CLZL.CQDH ');
      Active:=true;
   end;
 end else if PageControl1.ActivePage=TabSheet2 then
 begin
   with Qry2 do
   begin
      Active:=false;
      SQL.Clear;
      sql.add('  if object_id('+''''+'tempdb..#CLZLKC_LastK'+''''+') is not null  ');
      sql.add('begin   drop table #CLZLKC_LastK end   ');
      SQL.Add('select NowKC.CKBH,NowKC.CLBH,NowKC.SIZ,IsNull(NowKC.NowRKQty,0) as Qty into #CLZLKC_LastK from (');
      SQL.Add('  select CKBH,CLBH,SIZ,Sum(RKQty) as NowRKQty from (');
      SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
      SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and LTRKSS.ZLBH=''NEWL'' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+''' ');
      SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ ');
      SQL.Add('  Union All ');
      SQL.Add('  select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+'#L'' and KCYEAR='''+ayear+''' and KCMonth='''+amonth+''' ) as tmpRKTLFL ');
      SQL.Add('  group by CKBH,CLBH,SIZ ) as NowKC');
      SQL.Add('select #CLZLKC_LastK.CLBH,CLZL.YWPM, SUM(Qty) as Total,');
      for i:=0 to Qtemp1.RecordCount-1 do
      begin
        SQL.Add('   Max(case when SIZ='''+Qtemp1.FieldByName('XXCC').AsString+''' then Qty end) as ''['+Qtemp1.FieldByName('XXCC').AsString+']'', ');
        QTemp1.Next;
      end;
      SQL.Add('CLZL.CQDH ');
      SQL.Add('from #CLZLKC_LastK  ');
      SQL.Add('left join CLZL on CLZL.cldh=#CLZLKC_LastK.CLBH where 1=1 ');
      if EditMatNo.Text<>'' then
        SQL.Add('and #CLZLKC_LastK.CLBH like '''+EditMatNo.Text+'%'' ');
      if EditMatNM.Text<>'' then
        SQL.Add('and CLZL.YWPM like ''%'+EditMatNM.Text+'%'' ');
      SQL.Add('Group by #CLZLKC_LastK.CLBH,CLZL.YWPM,CLZL.CQDH ');
      Active:=true;
   end;
 end else if PageControl1.ActivePage=TabSheet3 then
 begin
   with Qry3 do
   begin
      Active:=false;
      sql.Clear;
      sql.add('  if object_id('+''''+'tempdb..#CLZLKC_LastOut'+''''+') is not null  ');
      sql.add('begin   drop table #CLZLKC_LastOut end   ');
      sql.add('select NowKC.DepID,NowKC.CLBH,NowKC.SIZ,IsNull(NowKC.NowLLQty,0)-IsNull(RK.RKQty,0) as Qty into #CLZLKC_LastOut  from ( ');
      sql.add('select DepID,CLBH,SIZ,Sum(LLQty) as NowLLQty from (');
      sql.add('select LTLL.DepID,LTLLSS.CLBH,LTLLSS.SIZ,SUM(LTLLSS.Qty) as LLQty from LTLLSS,LTLL ');
      sql.add('where LTLLSS.LLNO=LTLL.LLNO  and LTLL.CFMID<>''NO'' and LTLL.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTLL.CFMDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+'''  ');
      sql.add('Group by LTLL.DepID,LTLLSS.CLBH,LTLLSS.SIZ ');
      sql.add('Union All ');
      sql.add('select DepID,CLBH,SIZ,QTY as LastRem from Lastmonth_Out where CKBH='''+CBX1.Text+''' and  KCYEAR='''+ayear+''' and KCMonth='''+amonth+''') as tmpRKTLFL ');
      sql.add('group by DepID,CLBH,SIZ ) as NowKC ');
      sql.add('left join ( select LTRK.DepID,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK  ');
      sql.add('where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and LTRKSS.ZLBH=''LAST'' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+formatdatetime('yyyy/MM/dd',startofthemonth(DTP1.date))+''' and '''+formatdatetime('yyyy/MM/dd',DTP1.date)+''' ');
      sql.add('Group by LTRK.DepID,LTRKSS.CLBH,LTRKSS.SIZ )  RK on NowKC.DepID=RK.DepID and NowKC.CLBH=RK.CLBH and NowKC.SIZ=RK.SIZ ');
      sql.add('where  IsNull(NowKC.NowLLQty,0)-IsNull(RK.RKQty,0) >0 ');
      SQL.Add('select #CLZLKC_LastOut.DepID,#CLZLKC_LastOut.CLBH,CLZL.YWPM, SUM(Qty) as Total,');
      for i:=0 to Qtemp1.RecordCount-1 do
      begin
        SQL.Add('   Max(case when SIZ='''+Qtemp1.FieldByName('XXCC').AsString+''' then Qty end) as ''['+Qtemp1.FieldByName('XXCC').AsString+']'', ');
        QTemp1.Next;
      end;
      SQL.Add('CLZL.CQDH ');
      SQL.Add('from #CLZLKC_LastOut  ');
      SQL.Add('left join CLZL on CLZL.cldh=#CLZLKC_LastOut.CLBH where 1=1 ');
      if EditMatNo.Text<>'' then
        SQL.Add('and #CLZLKC_LastOut.CLBH like '''+EditMatNo.Text+'%'' ');
      if EditMatNM.Text<>'' then
        SQL.Add('and CLZL.YWPM like ''%'+EditMatNM.Text+'%'' ');
      SQL.Add('Group by #CLZLKC_LastOut.DepID,#CLZLKC_LastOut.CLBH,CLZL.YWPM,CLZL.CQDH ');
      Active:=true;
   end;
 end;
 //
 Qtemp1.Active:=false;
end;

procedure TLastSTOCK.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  action:=cafree;
end;

procedure TLastSTOCK.FormDestroy(Sender: TObject);
begin
  LastSTOCK:=nil;
end;

procedure TLastSTOCK.S1Click(Sender: TObject);
begin
      Laststock_Det:=TLaststock_Det.create(self);
      Laststock_Det.show;
end;
//Last Size Range
procedure TLastSTOCK.Last_Size_Range_Init();
  function GetDBGridTitle_Siz(str:string):string;
  begin
    result:=Copy(str,2,length(str)-2);
  end;
var i,j:integer;
begin
  //
  Qtemp1.Active:=false;
  Qtemp1.SQL.Clear;
  Qtemp1.SQL.Add('Select CLBH from LastSizeR Group by CLBH Order by CLBH ');
  Qtemp1.Active:=true;
  //
  if Qtemp1.RecordCount>0 then
  begin
    setlength(LastSizeR,Qtemp1.RecordCount);
    for i:=0  to Qtemp1.RecordCount-1 do
    begin
      LastSizeR[i].CLBH:=Qtemp1.FieldByName('CLBH').AsString;
      Qtemp1.Next;
    end;
    Qtemp1.Active:=false;
    for i:=0 to  High(LastSizeR) do
    begin
      Qtemp1.Active:=false;
      Qtemp1.SQL.Clear;
      Qtemp1.SQL.Add('Select SIZ from LastSizeR where CLBH='''+LastSizeR[i].CLBH+''' Order by SIZ ');
      Qtemp1.Active:=true;
      for j:=3 to 42 do
      begin
         if Qtemp1.Locate('SIZ',GetDBGridTitle_Siz(dbgrdh1.Columns[j].FieldName),[]) =true then
           LastSizeR[i].IsSizR[j-3]:=true
         else
           LastSizeR[i].IsSizR[j-3]:=false;
      end;
    end;
    //
  end;
  Qtemp1.Active:=false;
  //
end;
//
procedure TLastSTOCK.FormCreate(Sender: TObject);
var NDate:TDate;
begin
  with Qtemp1 do
  begin
    active:=false;
    sql.Clear;
    sql.add('select getdate() as NDate ');
    active:=true;
    NDate:=fieldbyname('NDate').Value;
    active:=false;
    sql.Clear;
    sql.add('select CKBH from KCCK ');
    sql.add('where GSBH='+''''+main.edit2.text+'''');
    sql.add('order by CKBH ');
    active:=true;
    CBX1.items.clear;
    while not eof do
      begin
        CBX1.items.add(fieldbyname('CKBH').AsString);
        next;
      end;
    CBX1.itemindex:=0;
    active:=false;
  end;
  DTP1.Date:=NDate;
  GetDateParam();
  Last_Size_Range_Init();
end;

procedure TLastStock.OutputExcel(Query:TQuery);
var eclApp,WorkBook:olevariant;
    i,j:integer;
begin
  if Query.Active=false then exit;
  try
    eclApp:=CreateOleObject('Excel.Application');
    WorkBook:=CreateOleObject('Excel.Sheet');
  except
    Application.MessageBox('NO Microsoft   Excel','Microsoft   Excel',MB_OK+MB_ICONWarning);
    Exit;
  end;

  try
    WorkBook:=eclApp.workbooks.Add;
    for   i:=0   to   Query.fieldcount-1   do
    begin
      eclApp.Cells(1,i+1):=Query.fields[i].FieldName;
    end;
    //抬頭顏色
    eclApp.Range[eclApp.Cells[1,1],eclApp.Cells[1,Query.fieldcount]].interior.color:=clyellow;
    eclApp.Range[eclApp.Cells[1,1],eclApp.Cells[1,Query.fieldcount]].font.color:=clred;
    eclApp.Range[eclApp.Cells[1,1],eclApp.Cells[Query.RecordCount+1,Query.fieldcount]].Borders.weight:=2;
    //
    Query.First;
    j:=2;
    while   not  Query.Eof   do
    begin
        for   i:=0   to   Query.fieldcount-1   do
        begin
          eclApp.Cells(j,i+1):=Query.Fields[i].Value;
        end;
        Query.Next;
        inc(j);
    end;
    eclapp.columns.autofit;
    showmessage('Succeed.');
    eclApp.Visible:=True;
  except
    on   F:Exception   do
      showmessage(F.Message);
  end;
end;
procedure TLastSTOCK.bbt6Click(Sender: TObject);
begin
  if PageControl1.ActivePage=TabSheet1 then
    OutputExcel(Qry1);
  if PageControl1.ActivePage=TabSheet2 then
    OutputExcel(Qry2);
end;

procedure TLastSTOCK.BB1Click(Sender: TObject);
begin
  panel2.Visible:=true;
end;

//檢查上個月是否結算資料
function TLastSTOCK.CheckLastMonthEnding():boolean;
begin

 with  Qtemp1 do
 begin
    Active:=false;
    SQL.Clear;
    SQL.Add('Select KCYear from LASTMONTH where CKBH='''+CBX1.Text+''' and KCYear='''+LastYear+''' and KCMonth='''+LastMon+''' ');
    Active:=true;
    //是否有上個月資料
    if RecordCount=0 then
      result:=false
    else
      result:=true;
    active:=false;
 end;

end;

procedure TLastSTOCK.BB2Click(Sender: TObject);
begin
 //if  Messagedlg(Pchar('Are you sure caluate Monthly Ending?'),mtInformation,[mbYES,mbNo],0)=mrYes then
  //檢查是否月結資料是否已經存在
  if CheckLastMonthEnding()=false then
  begin
      //產生月結資料
      with  Qtemp1 do
      begin

        Active:=false;
        SQL.Clear;
        SQL.Add('Insert into LASTMONTH ');
        SQL.Add('select '''+LastYear+''' as KCYear,'''+LastMon+''' as KCMonth,NowKC.CKBH,NowKC.CLBH,NowKC.SIZ,IsNull(NowKC.NowRKQty,0)-IsNull(LL.LLQty,0) as Qty,'''+main.Edit1.Text+''',GetDate(),''1''  from (');
        SQL.Add('  select CKBH,CLBH,SIZ,Sum(RKQty) as NowRKQty from (');
        SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
        SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+''' ');
        SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ ');
        SQL.Add('  Union All ');
        SQL.Add('  select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+''' and KCYEAR='''+LastYear2+''' and KCMonth='''+LastMon2+''' ) as tmpRKTLFL ');
        SQL.Add('  group by CKBH,CLBH,SIZ ) as NowKC');
        SQL.Add('left join ( ');
        SQL.Add('   select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+''' and KCYEAR='''+LastYear2+''' and KCMonth='''+LastMon2+''' ) as LastKC on NowKC.CKBH=LastKC.CKBH and NowKC.CLBH=LastKC.CLBH and NowKC.SIZ=LastKC.SIZ');
        SQL.Add('left join ( ');
        SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
        SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+''' ');
        SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ  ) RK on NowKC.CKBH=RK.CKBH and NowKC.CLBH=RK.CLBH and NowKC.SIZ=RK.SIZ');
        SQL.Add('left join ( ');
        SQL.Add('   select LTLL.CKBH,LTLLSS.CLBH,LTLLSS.SIZ,SUM(LTLLSS.Qty) as LLQty from LTLLSS,LTLL ');
        SQL.Add('   where LTLLSS.LLNO=LTLL.LLNO  and LTLL.CFMID<>''NO'' and LTLL.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTLL.CFMDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+''' ');
        SQL.Add('   Group by LTLL.CKBH,LTLLSS.CLBH,LTLLSS.SIZ ) LL on NowKC.CKBH=LL.CKBH and NowKC.CLBH=LL.CLBH and NowKC.SIZ=LL.SIZ');
        ExecSQL();
        //月結全部庫存
        Active:=false;
        SQL.Clear;
        SQL.Add('Insert into LASTMONTH ');
        //20161101  IsNull(NowKC.NowRKQty,0) -> IsNull(Sum(NowKC.NowRKQty),0)
        SQL.Add('select '''+LastYear+''' as KCYear,'''+LastMon+''' as KCMonth,'''+CBX1.Text+'#L'',NowKC.CLBH,NowKC.SIZ,IsNull(Sum(NowKC.NowRKQty),0),'''+main.Edit1.Text+''',GetDate(),''1''  from (');
        SQL.Add('  select CKBH,CLBH,SIZ,Sum(RKQty) as NowRKQty from (');
        SQL.Add('  select LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK ');
        SQL.Add('  where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and LTRKSS.ZLBH=''NEWL'' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+''' ');
        SQL.Add('  Group by LTRK.CKBH,LTRKSS.CLBH,LTRKSS.SIZ ');
        SQL.Add('  Union All ');
        SQL.Add('  select CKBH,CLBH,SIZ,QTY as LastRem from Lastmonth where CKBH='''+CBX1.Text+'#L'' and KCYEAR='''+LastYear2+''' and KCMonth='''+LastMon2+''' ) as tmpRKTLFL ');
        SQL.Add('  group by CKBH,CLBH,SIZ) as NowKC');
        sql.Add('  group by NowKC.CLBH,NowKC.SIZ'); 
        ExecSQL();

        //月結流通在外
        Active:=false;
        SQL.Clear;
        SQL.Add('Delete from LASTMONTH_Out where KCYear='''+LastYear+''' and KCMonth='''+LastMon+''' and CKBH='''+CBX1.Text+''' ');
        SQL.Add('Insert into LASTMONTH_Out ');
        sql.add('select '''+CBX1.Text+''' as CKBH,'''+LastYear+''' as KCYear,'''+LastMon+''' as KCMonth,NowKC.DepID,NowKC.CLBH,NowKC.SIZ,IsNull(NowKC.NowLLQty,0)-IsNull(RK.RKQty,0) as Qty,'''+main.Edit1.Text+''',GetDate(),''1''  from ( ');
        sql.add('select DepID,CLBH,SIZ,Sum(LLQty) as NowLLQty from (');
        sql.add('select LTLL.DepID,LTLLSS.CLBH,LTLLSS.SIZ,SUM(LTLLSS.Qty) as LLQty from LTLLSS,LTLL ');
        sql.add('where LTLLSS.LLNO=LTLL.LLNO  and LTLL.CFMID<>''NO'' and LTLL.CKBH='''+CBX1.Text+''' and convert(smalldatetime,convert(varchar,LTLL.CFMDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+'''  ');
        sql.add('Group by LTLL.DepID,LTLLSS.CLBH,LTLLSS.SIZ ');
        sql.add('Union All ');
        sql.add('select DepID,CLBH,SIZ,QTY as LastRem from Lastmonth_Out where  KCYEAR='''+LastYear2+''' and KCMonth='''+LastMon2+''' and CKBH='''+CBX1.Text+''' ) as tmpRKTLFL ');
        sql.add('group by DepID,CLBH,SIZ ) as NowKC ');
        sql.add('left join ( select LTRK.DepID,LTRKSS.CLBH,LTRKSS.SIZ,SUM(LTRKSS.Qty) as RKQty from LTRKSS,LTRK  ');
        sql.add('where LTRKSS.RKNO=LTRK.RKNO  and LTRK.CKBH='''+CBX1.Text+''' and LTRKSS.ZLBH=''LAST'' and convert(smalldatetime,convert(varchar,LTRK.UserDate,111)) between '''+STLastMonDate+''' and '''+EDLastMonDate+''' ');
        sql.add('Group by LTRK.DepID,LTRKSS.CLBH,LTRKSS.SIZ )  RK on NowKC.DepID=RK.DepID and NowKC.CLBH=RK.CLBH and NowKC.SIZ=RK.SIZ ');
        sql.add('where  IsNull(NowKC.NowLLQty,0)-IsNull(RK.RKQty,0) >0 ');
        ExecSQL();
      end;

      if CheckLastMonthEnding()=true then LastMonth.Caption:='';
      showmessage('Tinh het / Calculate over!');

  end else
  begin
    showmessage(' Co ket thuc hang thang /Have Monthly Ending!');
  end;
  
end;

procedure TLastSTOCK.DTP1Change(Sender: TObject);
begin
  //取得時間參數
  GetDateParam();
end;
//
procedure TLastSTOCK.dbgrdh1DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumnEh;
  State: TGridDrawState);
var i:integer;
begin
  //
  if qry1.FieldByName('CLBH').AsString<>'' then
  begin
    DBGrdh1.Canvas.Brush.Color:=clLime;
    for i:=0 to High(LastSizeR) do
    begin
      if LastSizeR[i].CLBH = qry1.FieldByName('CLBH').AsString then
      begin
         if DataCol>=3 then
           if LastSizeR[i].IsSizR[DataCol-3]=true then
             DBGrdh1.DefaultDrawColumnCell(Rect, DataCol, Column, State);
         break;
      end;
    end;
  end;
  //
end;

procedure TLastSTOCK.dbgrdh2DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumnEh;
  State: TGridDrawState);
var i:integer;
begin
  //
  if qry2.FieldByName('CLBH').AsString<>'' then
  begin
    dbgrdh2.Canvas.Brush.Color:=clLime;
    for i:=0 to High(LastSizeR) do
    begin
      if LastSizeR[i].CLBH = qry2.FieldByName('CLBH').AsString then
      begin
         if DataCol>=3 then
           if LastSizeR[i].IsSizR[DataCol-3]=true then
             dbgrdh2.DefaultDrawColumnCell(Rect, DataCol, Column, State);
         break;
      end;
    end;
  end;
  //

end;

end.
