if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by #CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
and isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) >0
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'A%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'A%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'A%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'A%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'A%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'A%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'A%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'A%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'A%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'A%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'A%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'A%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'A%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'A%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'A%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'A%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'A%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'A%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'A%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'A%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'A%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'A%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'A%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'A%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'A%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/01'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/01'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/01'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/01'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='09'
           and KCCLMONTH.CLBH like '%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/10/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/10/01'
           and KCRKS.CLBH like '%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/10/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/10/01'
           and KCLLS.CLBH like '%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/10/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/10/01'
           and JGZLS.CLBH like '%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/10/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/10/01'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/10/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/10/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like '%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/10/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/10/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like '%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like '%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='10' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like '%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P21%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P21%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P21%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P21%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P21%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P21%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P21%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P21%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
and KCZLS.KCBH like '1%' 
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
and KCZLS.KCBH like '1%' 
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT,KCZLS.DFL,KCZLS.KCBH
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P210021153%' 
        and KCCLMONTH.CKBH in ('VDH') 
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P210021153%'
           and KCRK.CKBH in ('VDH') 
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P210021153%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH in ('VDH') 
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P210021153%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH in ('VDH') 
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH in ('VDH') 
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P210021153%' 
        and KCLL.CKBH in ('VDH') 
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='ALL'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P210021153%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH in ('VDH') 
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select 'ALL' as HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,max (case when #CLZLKC.LBBH>CLLBFLS.LBBH then #CLZLKC.LBBH else CLLBFLS.LBBH end ) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,
       sum(isnull(#CLZLKC.LastRem,0)) as LastRem,
       sum(isnull(round(#CLZLKC.RKQty,2),0)) as RKQty,
       sum(isnull(round(#CLZLKC.LLQty,2),0)) as LLQty,
       sum(isnull(round(#CLZLKC.JGRK,2),0)) as JGRK,
       sum(isnull(round(#CLZLKC.JGCK,2),0)) as JGCK,
       sum(isnull(round(#CLZLKC.JGCKTemp,2),0)) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,
       Max(KCBH) as KCBH,'ALL' as CKBH,
       sum(isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0)) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
and #CLZLKC.CLDH like 'P210021153%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
Group by clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,Mat.STT,KCZLS.DFL,KCZLS.KCBH
order by Mat.STT,#CLZLKC.CLDH
if object_id('tempdb..#CLZLKC') is not null  
begin   drop table #CLZLKC end   
select KCZLS.CKBH,KCZLS.CLBH as CLDH,LastKC.LBBH,LastKC.LastRem,RK.RKQty,LL.LLQty,JGRK.JGRK,JGCK.JGCK,JGCKTemp.JGCK as JGCKTemp into #CLZLKC  
from KCZLS with (nolock) 
Left join ( 
     Select KCCLMONTH.CKBH,KCCLMONTH.CLBH,Max(KCCLMONTH.LBBH) as LBBH,Sum(KCCLMONTH.Qty) as LastRem 
     from KCCLMONTH_HG as KCCLMONTH   with (nolock) 
     where KCCLMONTH.KCYEAR='2025' 
           and KCMONTH='10'
           and KCCLMONTH.CLBH like 'P21%' 
        and KCCLMONTH.CKBH='VDH'
      Group by  KCCLMONTH.CKBH,KCCLMONTH.CLBH 
      ) LastKC  on LastKC.CLBH=KCZLS.CLBH and LastKC.CKBH=KCZLS.CKBH 
left join (select KCRK.CKBH,KCRKS.CLBH,sum(KCRKS.Qty) as RKQty from KCRKS with (nolock)  
           left join KCRK with (nolock)   on KCRK.RKNO=KCRKS.RKNO where convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCRK.USERDATE,111))<=
           '2025/11/13'
           and KCRKS.CLBH like 'P21%'
           and KCRK.CKBH='VDH'
           group by KCRK.CKBH,KCRKS.CLBH) RK on RK.CLBH=KCZLS.CLBH  and RK.CKBH=KCZLS.ckbh
left join (select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS with (nolock)   
           left join KCLL with (nolock)    on KCLL.LLNO=KCLLS.LLNO where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
           '2025/11/13'
           and KCLLS.CLBH like 'P21%' 
           and KCLL.CFMID<>'NO'
           and KCLL.SCBH<>'JJJJJJJJJJ'
           and KCLL.CKBH='VDH'
           group by KCLL.CKBH,KCLLS.CLBH) LL on LL.CLBH=KCZLS.CLBH and LL.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.CLBH,sum(JGZLS.Qty) as JGRK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and JGZLS.CLBH like 'P21%' 
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB='ZZZZZZZZZZ' 
           and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.CLBH ) JGRK on JGRK.CLBH=KCZLS.CLBH and JGRK.CKBH=KCZLS.CKBH
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
                      '2025/11/01'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
                      '2025/11/13'
                      and JGZL.CFMID1 <>'NO'
                      and JGZLS.ZMLB='ZZZZZZZZZZ'
                      and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
                   and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))>=
           '2025/11/01'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<=
           '2025/11/13'
           and convert(smalldatetime,convert(varchar,JGZL.CFMDate1,111))<'2017/09/01'
           and JGZLS.ZMLB like 'P21%'
           and JGZL.CFMID1 <>'NO' 
           and JGZLS.ZMLB<>'ZZZZZZZZZZ' 
        and JGZL.CKBH='VDH'
        group by JGZL.CKBH,JGZLS.ZMLB 
        union all
        select KCLL.CKBH,KCLLS.CLBH,sum(KCLLS.Qty) as LLQty from KCLLS 
        left join KCLL on KCLL.LLNO=KCLLS.LLNO 
        where convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>=
        '2025/11/01'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))<=
        '2025/11/13'
        and convert(smalldatetime,convert(varchar,KCLL.CFMDATE,111))>='2017/09/01'
        and KCLL.SCBH = 'JJJJJJJJJJ' and KCLL.CFMID<>'NO'
        and KCLLS.CLBH like 'P21%' 
        and KCLL.CKBH='VDH'
         group by KCLL.CKBH,KCLLS.CLBH
        ) JGCK on JGCK.ZMLB=KCZLS.CLBH and JGCK.CKBH=KCZLS.ckbh
left join (select JGZL.CKBH,JGZLS.ZMLB,convert(money,sum(round(convert(float,JGZLS.Qty)*convert(float,JGZLM.Qty),2))) as JGCK from JGZLS with (nolock) 
           left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO  
           left join (select JGZLS.JGNO,JGZLS.CLBH,JGZLS.Qty from JGZLS  with (nolock) 
                      left join JGZL  with (nolock) on JGZL.JGNO=JGZLS.JGNO 
                      where  JGZLS.ZMLB='ZZZZZZZZZZ'
                      and JGZL.CKBH='VDH'
                      ) JGZLM on JGZLM.JGNO=JGZLS.JGNO and JGZLM.CLBH=JGZLS.CLBH
           where  JGZLS.ZMLB like 'P21%'
           and JGZL.CFMID1 ='NO'
           and JGZLS.ZMLB<>'ZZZZZZZZZZ'
        and JGZL.CKBH='VDH'
           group by JGZL.CKBH,JGZLS.ZMLB ) JGCKTemp on JGCKTemp.ZMLB=KCZLS.CLBH and JGCKTemp.CKBH=KCZLS.ckbh
where  not (LastKC.LastRem is null  and RK.RKQty is null and LL.LLQty is null and JGRK.JGRK is null and JGCK.JGCK is null and JGCKTemp.JGCK is null) 
select CLHG.HGBH,clzl.zsdh,zszl.zsqm,#CLZLKC.CLDH,IsNull(CLLBFLS.LBBH,#CLZLKC.LBBH) as LBBH,CLZL.YWPM,CLZL.ZWPM,CLZL.DWBH,isnull(#CLZLKC.LastRem,0) as LastRem,
       isnull(round(#CLZLKC.RKQty,2),0) as RKQty,isnull(round(#CLZLKC.LLQty,2),0) as LLQty,
       isnull(round(#CLZLKC.JGRK,2),0) as JGRK,isnull(round(#CLZLKC.JGCK,2),0) as JGCK,
       isnull(round(#CLZLKC.JGCKTemp,2),0) as JGCKTemp,ISnull(KCZLS.DFL,KCZLS.KCBH) as DFL,KCZLS.CKBH,KCZLS.KCBH,
       isnull(Round(#CLZLKC.LastRem,2),0)+isnull(Round(#CLZLKC.RKQty,2),0)-isnull(Round(#CLZLKC.LLQty,2),0)+isnull(Round(#CLZLKC.JGRK,2),0)-isnull(Round(#CLZLKC.JGCK,2),0) as Qty, Mat.STT
from #CLZLKC 
left join CLZL on CLZL.CLDH=#CLZLKC.CLDH
left join zszl on zszl.zsdh=clzl.zsdh 
left join  KCZLS on KCZLS.CLBH=#CLZLKC.CLDH  and KCZLS.CKBH=#CLZLKC.CKBH 
left join CLLBFLS on CLLBFLS.CLBH=CLZL.CLDH and CLLBFLS.GSBH='VDH' 
left join CLHG on CLHG.CLBH=#CLZLKC.CLDH  
left join KCCLMONTH_Mat_Order Mat on  Mat.CKBH=#CLZLKC.CKBH and Mat.CLBH=#CLZLKC.CLDH  and Mat.KCYEAR='2025'  and Mat.KCMONTH='11' 
where
 not (#CLZLKC.LastRem is null  and #CLZLKC.RKQty is null and #CLZLKC.LLQty is null 
               and #CLZLKC.JGRK is null and #CLZLKC.JGCK is null and #CLZLKC.JGCKTemp is null) 
 and KCZLS.CKBH='VDH' 
and #CLZLKC.CLDH like 'P21%'
and CLZL.YWPM like '%%'
and CLZL.YWPM like '%%'
order by Mat.STT,#CLZLKC.CLDH
