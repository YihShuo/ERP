-----------------------------------------------------考勤大於薪資筆數
Select * from (
select  ST_LUONG.*,
        case when L_NGHIO>0 or (NV_NGAYVAO>='2021/01/01' and NV_NGAYVAO>='2021/01/31' ) or (L_NGHIRO/8)>=3 or ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)>(L_SONGAYCONGTRONGTHANG/2) then
		       0
		     else
			   case when  L_NGHIRO=0 and ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)<=4 then 1 else 0.5 end
             end
	    as HESONGAYCONG
from (
Select '01-2021' as T_MA,
       ST_NHANVIEN.NV_Ma, 
       ST_NHANVIEN.NV_Ten, 
       ST_NHANVIEN.DV_MA, 
       ST_DONVI.DV_Ten,  
       ST_NHANVIEN.NV_Ngayvao, 
       ST_NHANVIEN.CVU_MA, 
       ST_CHUCVU.CVU_TEN, 
       ST_NHANVIEN.CV_MA, 
       ST_CONGVIEC.CV_TEN,
	      NV_THOIVIEC = CASE WHEN NOT ST_NHANVIENTHOIVIEC.TV_NgayThoiViec IS NULL THEN  1 ELSE 0 END,
	      ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
       ST_THANG.T_SONGAYCONG as L_SONGAYCONGTRONGTHANG
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 then ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end)  as SONGAYCONG
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='P') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIP
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='Dq') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIDQ
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='R') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHILE 
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='R') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIR
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='RO') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIRO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='OM') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIOM
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='ST') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIST
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='TS') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHITS
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='O') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='NO') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHINO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='KThai') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIKHAMTHAI
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='Ds') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIDS
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='KHHGD') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIKHHGD
From  ST_NHANVIEN ST_NHANVIEN 
INNER JOIN ST_GIOQUETTHE ST_GIOQUETTHE ON ST_NHANVIEN.NV_MA = ST_GIOQUETTHE.NV_MA
LEFT JOIN ST_DONVI ST_DONVI ON ST_NHANVIEN.DV_MA = ST_DONVI.DV_MA
LEFT JOIN ST_CONGVIEC ST_CONGVIEC ON ST_NHANVIEN.CV_MA = ST_CONGVIEC.CV_MA
LEFT JOIN ST_CHUCVU ST_CHUCVU  ON ST_NHANVIEN.CVU_MA = ST_CHUCVU.CVU_MA
LEFT join ST_THANG ST_THANG on ST_THANG.T_MA='01-2021' 
LEFT JOIN ST_NHANVIENTHOIVIEC ST_NHANVIENTHOIVIEC ON ST_NHANVIEN.NV_MA = ST_NHANVIENTHOIVIEC.NV_MA
WHERE ST_NHANVIEN.NV_MA NOT IN (SELECT NV_MA FROM ST_NHANVIENTHOIVIEC where TV_NgayThoiViec<DATEADD(dd,-1,'2021/01/01'))
   AND ST_NHANVIEN.DV_MA is not null 
	  AND ST_NHANVIEN.NV_NGAYVAO <= '2021/01/31' 
	  AND ST_GIOQUETTHE.QT_NGAY BETWEEN '2021/01/01'  AND '2021/01/31' 
Group by ST_NHANVIEN.NV_Ma,ST_NHANVIEN.NV_Ten, ST_NHANVIEN.DV_MA,ST_DONVI.DV_Ten,  ST_NHANVIEN.NV_Ngayvao,ST_NHANVIEN.CV_MA,ST_CONGVIEC.CV_TEN,ST_NHANVIENTHOIVIEC.TV_NgayThoiViec, 
       ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,ST_NHANVIEN.CVU_MA, ST_CHUCVU.CVU_TEN, ST_NHANVIEN.CM_MA,ST_CONGVIEC.CV_TEN, ST_THANG.T_SONGAYCONG 
) ST_LUONG   

) A
Left join (

select  ST_LUONG.*,
        case when L_NGHIO>0 or (NV_NGAYVAO>='2021/01/01' and NV_NGAYVAO>='2021/01/31' ) or (L_NGHIRO/8)>=3 or ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)>(L_SONGAYCONGTRONGTHANG/2) then
		       0
		     else
			   case when  L_NGHIRO=0 and ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)<=4 then 1 else 0.5 end
             end
	    as HESONGAYCONG
from (
SELECT
 ST_LUONG.T_MA,
	ST_NHANVIEN.NV_MA,
	ST_NHANVIEN.NV_TEN,
	ST_LUONG.DV_MA,
	ST_DONVI.DV_TEN,
	ST_NHANVIEN.NV_NGAYVAO,
	ST_NHANVIEN.CVU_MA,
	ST_CHUCVU.CVU_TEN,
	ST_NHANVIEN.CV_MA,
	ST_CONGVIEC.CV_TEN,
	NV_THOIVIEC = CASE WHEN NOT ST_NHANVIENTHOIVIEC.TV_NgayThoiViec IS NULL THEN  1 ELSE 0 END,
	ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
	ST_THANG.T_SONGAYCONG as L_SONGAYCONGTRONGTHANG,
	Sum(ST_LUONG.L_CONGHS1) as SONGAYCONG,
	Sum(ST_LUONG.L_NGHIDQ) as L_NGHIDQ,
 Sum(ST_LUONG.L_NGHILE) as L_NGHILE,
	Sum(ST_LUONG.L_NGHIP) as L_NGHIP,
	Sum(ST_LUONG.L_NGHIR) as L_NGHIR,
	Sum(ST_LUONG.L_NGHIRO) as L_NGHIRO,
	Sum(ST_LUONG.L_NGHIOM) as L_NGHIOM,
	Sum(ST_LUONG.L_NGHIST) as L_NGHIST,
	Sum(ST_LUONG.L_NGHITS) as L_NGHITS,
	Sum(ST_LUONG.L_NGHIO) as L_NGHIO,
	Sum(ST_LUONG.L_NGHINO) as L_NGHINO,
	Sum(ST_LUONG.L_NGHIKHAMTHAI) as L_NGHIKHAMTHAI,
 Sum(ST_LUONG.L_NGHIDS) as L_NGHIDS,
	Sum(ST_LUONG.L_NGHIKHHGD) as L_NGHIKHHGD
 FROM ST_LUONG ST_LUONG
 INNER JOIN ST_NHANVIEN ST_NHANVIEN ON ST_LUONG.NV_MA = ST_NHANVIEN.NV_MA
	LEFT JOIN ST_DONVI ST_DONVI on ST_DONVI.DV_MA=ST_LUONG.DV_MA
	LEFT JOIN ST_CHUCVU ST_CHUCVU ON ST_NHANVIEN.CVU_MA = ST_CHUCVU.CVU_MA
	LEFT JOIN ST_CONGVIEC ST_CONGVIEC ON ST_NHANVIEN.CV_MA = ST_CONGVIEC.CV_MA
 LEFT join ST_THANG ST_THANG on ST_THANG.T_MA='01-2021' 
	LEFT JOIN ST_NHANVIENTHOIVIEC ST_NHANVIENTHOIVIEC ON ST_NHANVIEN.NV_MA = ST_NHANVIENTHOIVIEC.NV_MA
WHERE ST_LUONG.T_MA = '01-2021'  
Group by  ST_LUONG.T_MA,
	ST_NHANVIEN.NV_MA,
	ST_NHANVIEN.NV_TEN,
	ST_LUONG.DV_MA,
	ST_DONVI.DV_TEN,
	ST_NHANVIEN.NV_NGAYVAO,
	ST_NHANVIEN.CVU_MA,
	ST_CHUCVU.CVU_TEN,
	ST_NHANVIEN.CV_MA,
	ST_CONGVIEC.CV_TEN,
	ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
	ST_THANG.T_SONGAYCONG
) ST_LUONG 
)  B on A.NV_Ma=B.NV_Ma
where  B.NV_MA is null
-------------------------------------------------------------------------------薪資大於考勤筆數檢查
Select * from (
select  ST_LUONG.*,
        case when L_NGHIO>0 or (NV_NGAYVAO>='2021/01/01' and NV_NGAYVAO>='2021/01/31' ) or (L_NGHIRO/8)>=3 or ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)>(L_SONGAYCONGTRONGTHANG/2) then
		       0
		     else
			   case when  L_NGHIRO=0 and ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)<=4 then 1 else 0.5 end
             end
	    as HESONGAYCONG
from (
SELECT
 ST_LUONG.T_MA,
	ST_NHANVIEN.NV_MA,
	ST_NHANVIEN.NV_TEN,
	ST_LUONG.DV_MA,
	ST_DONVI.DV_TEN,
	ST_NHANVIEN.NV_NGAYVAO,
	ST_NHANVIEN.CVU_MA,
	ST_CHUCVU.CVU_TEN,
	ST_NHANVIEN.CV_MA,
	ST_CONGVIEC.CV_TEN,
	NV_THOIVIEC = CASE WHEN NOT ST_NHANVIENTHOIVIEC.TV_NgayThoiViec IS NULL THEN  1 ELSE 0 END,
	ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
	ST_THANG.T_SONGAYCONG as L_SONGAYCONGTRONGTHANG,
	Sum(ST_LUONG.L_CONGHS1) as SONGAYCONG,
	Sum(ST_LUONG.L_NGHIDQ) as L_NGHIDQ,
 Sum(ST_LUONG.L_NGHILE) as L_NGHILE,
	Sum(ST_LUONG.L_NGHIP) as L_NGHIP,
	Sum(ST_LUONG.L_NGHIR) as L_NGHIR,
	Sum(ST_LUONG.L_NGHIRO) as L_NGHIRO,
	Sum(ST_LUONG.L_NGHIOM) as L_NGHIOM,
	Sum(ST_LUONG.L_NGHIST) as L_NGHIST,
	Sum(ST_LUONG.L_NGHITS) as L_NGHITS,
	Sum(ST_LUONG.L_NGHIO) as L_NGHIO,
	Sum(ST_LUONG.L_NGHINO) as L_NGHINO,
	Sum(ST_LUONG.L_NGHIKHAMTHAI) as L_NGHIKHAMTHAI,
 Sum(ST_LUONG.L_NGHIDS) as L_NGHIDS,
	Sum(ST_LUONG.L_NGHIKHHGD) as L_NGHIKHHGD
 FROM ST_LUONG ST_LUONG
 INNER JOIN ST_NHANVIEN ST_NHANVIEN ON ST_LUONG.NV_MA = ST_NHANVIEN.NV_MA
	LEFT JOIN ST_DONVI ST_DONVI on ST_DONVI.DV_MA=ST_LUONG.DV_MA
	LEFT JOIN ST_CHUCVU ST_CHUCVU ON ST_NHANVIEN.CVU_MA = ST_CHUCVU.CVU_MA
	LEFT JOIN ST_CONGVIEC ST_CONGVIEC ON ST_NHANVIEN.CV_MA = ST_CONGVIEC.CV_MA
 LEFT join ST_THANG ST_THANG on ST_THANG.T_MA='01-2021' 
	LEFT JOIN ST_NHANVIENTHOIVIEC ST_NHANVIENTHOIVIEC ON ST_NHANVIEN.NV_MA = ST_NHANVIENTHOIVIEC.NV_MA
WHERE ST_LUONG.T_MA = '01-2021'  
Group by  ST_LUONG.T_MA,
	ST_NHANVIEN.NV_MA,
	ST_NHANVIEN.NV_TEN,
	ST_LUONG.DV_MA,
	ST_DONVI.DV_TEN,
	ST_NHANVIEN.NV_NGAYVAO,
	ST_NHANVIEN.CVU_MA,
	ST_CHUCVU.CVU_TEN,
	ST_NHANVIEN.CV_MA,
	ST_CONGVIEC.CV_TEN,
	ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
	ST_THANG.T_SONGAYCONG
) ST_LUONG  ) A
Left join (

select  ST_LUONG.*,
        case when L_NGHIO>0 or (NV_NGAYVAO>='2021/01/01' and NV_NGAYVAO>='2021/01/31' ) or (L_NGHIRO/8)>=3 or ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)>(L_SONGAYCONGTRONGTHANG/2) then
		       0
		     else
			   case when  L_NGHIRO=0 and ((L_NGHIDQ+L_NGHILE+L_NGHIP+L_NGHIR+L_NGHIOM+L_NGHIST+L_NGHITS+L_NGHIO+L_NGHINO+L_NGHIKHAMTHAI+L_NGHIDS+L_NGHIKHHGD)/8)<=4 then 1 else 0.5 end
             end
	    as HESONGAYCONG
from (
Select '01-2021' as T_MA,
       ST_NHANVIEN.NV_Ma, 
       ST_NHANVIEN.NV_Ten, 
       ST_NHANVIEN.DV_MA, 
       ST_DONVI.DV_Ten,  
       ST_NHANVIEN.NV_Ngayvao, 
       ST_NHANVIEN.CVU_MA, 
       ST_CHUCVU.CVU_TEN, 
       ST_NHANVIEN.CV_MA, 
       ST_CONGVIEC.CV_TEN,
	      NV_THOIVIEC = CASE WHEN NOT ST_NHANVIENTHOIVIEC.TV_NgayThoiViec IS NULL THEN  1 ELSE 0 END,
	      ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,
       ST_THANG.T_SONGAYCONG as L_SONGAYCONGTRONGTHANG
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 then ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end)  as SONGAYCONG
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='P') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIP
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='Dq') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIDQ
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='R') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHILE 
       ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='R') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIR
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='RO') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIRO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='OM') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIOM
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='ST') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIST
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='TS') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHITS
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='O') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='NO') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHINO
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='KThai') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIKHAMTHAI
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='Ds') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIDS
	      ,Sum(case when ST_GIOQUETTHE.CC_HESONGAYCONG=1 and (ST_GIOQUETTHE.NP_MA='KHHGD') then 8-ST_GIOQUETTHE.CC_GIOBINHTHUONG else 0 end) as L_NGHIKHHGD
From  ST_NHANVIEN ST_NHANVIEN 
INNER JOIN ST_GIOQUETTHE ST_GIOQUETTHE ON ST_NHANVIEN.NV_MA = ST_GIOQUETTHE.NV_MA
LEFT JOIN ST_DONVI ST_DONVI ON ST_NHANVIEN.DV_MA = ST_DONVI.DV_MA
LEFT JOIN ST_CONGVIEC ST_CONGVIEC ON ST_NHANVIEN.CV_MA = ST_CONGVIEC.CV_MA
LEFT JOIN ST_CHUCVU ST_CHUCVU  ON ST_NHANVIEN.CVU_MA = ST_CHUCVU.CVU_MA
LEFT join ST_THANG ST_THANG on ST_THANG.T_MA='01-2021' 
LEFT JOIN ST_NHANVIENTHOIVIEC ST_NHANVIENTHOIVIEC ON ST_NHANVIEN.NV_MA = ST_NHANVIENTHOIVIEC.NV_MA
WHERE ST_NHANVIEN.NV_MA NOT IN (SELECT NV_MA FROM ST_NHANVIENTHOIVIEC where TV_NgayThoiViec<DATEADD(dd,-1,'2021/01/01'))
   AND ST_NHANVIEN.DV_MA is not null 
	  AND ST_NHANVIEN.NV_NGAYVAO <= '2021/01/31' 
	  AND ST_GIOQUETTHE.QT_NGAY BETWEEN '2021/01/01'  AND '2021/01/31' 
Group by ST_NHANVIEN.NV_Ma,ST_NHANVIEN.NV_Ten, ST_NHANVIEN.DV_MA,ST_DONVI.DV_Ten,  ST_NHANVIEN.NV_Ngayvao,ST_NHANVIEN.CV_MA,ST_CONGVIEC.CV_TEN,ST_NHANVIENTHOIVIEC.TV_NgayThoiViec, 
       ST_NHANVIENTHOIVIEC.TV_NgayThoiViec,ST_NHANVIEN.CVU_MA, ST_CHUCVU.CVU_TEN, ST_NHANVIEN.CM_MA,ST_CONGVIEC.CV_TEN, ST_THANG.T_SONGAYCONG 
) ST_LUONG   )  B on A.NV_Ma=B.NV_Ma
where  B.NV_MA is null


